<html>
	<head>
		<title>SPARK: Stream Processing Abstraction and Rendering Toolkit</title>
		<link HREF="style.css" REL="stylesheet" TYPE="text/css">
	</head>
	<body>
		<div width="100%" height="40px" class="banner">
			Spark API Documentation
		</div>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>SpTurbulenceOp.cpp</h1><a href="SpTurbulenceOp_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="preprocessor">#include "<a class="code" href="SpTurbulenceOp_8h.html">SpTurbulenceOp.h</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="SpGlslManager_8h.html">SpGlslManager.h</a>"</span>
00003 <span class="preprocessor">#include "SpSpGlslVertexProgram.h"</span>
00004 <span class="preprocessor">#include "<a class="code" href="SpGlslFragmentProgram_8h.html">SpGlslFragmentProgram.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="SpStreamOperator_8h.html">SpStreamOperator.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="SpGlutHeaders_8h.html">SpGlutHeaders.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="SpGlManager_8h.html">SpGlManager.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="SpMaths_8h.html">SpMaths.h</a>"</span>
00009 
00010 <span class="preprocessor">#include &lt;cassert&gt;</span>
00011 
00012 <span class="comment">// ---------------------------------------------------------------------------</span>
00013 
00014 <span class="keyword">using</span> <span class="keyword">namespace </span>Spark;
00015 
00016 <span class="comment">//----------------------------------------------------------------------------</span>
00017 
00018 <span class="comment">// Filenames for the vertex and fragment programs being used internally</span>
00019 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classSpark_1_1SpString.html">SpString</a> kVPTex2DFilename = <span class="stringliteral">"VPAddMultiTex2D8.glsl"</span>;
00020 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classSpark_1_1SpString.html">SpString</a> kFPTex2DFilename = <span class="stringliteral">"FPAddMultiTex2D16.glsl"</span>;
00021 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classSpark_1_1SpString.html">SpString</a> kFPTex2DRectFilename = <span class="stringliteral">"FPAddMultiTex2DRect16.glsl"</span>;
00022 
00023 <span class="comment">// Must match the parameters in the fragment program being used</span>
00024 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classSpark_1_1SpString.html">SpString</a> kTextureParam = <span class="stringliteral">"texture"</span>;
00025 
00026 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00027"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a0">00027</a> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a0">SpTurbulenceOp::SpTurbulenceOp</a>(
00028     <span class="keywordtype">float</span> fX, <span class="keywordtype">float</span> fY, <span class="keywordtype">float</span> fZ,
00029     <span class="keywordtype">float</span> fOctaves,
00030     <span class="keywordtype">float</span> fIncrement,
00031     <span class="keywordtype">float</span> fLacunarity)
00032 :
00033     <a class="code" href="classSpark_1_1SpStreamOperator.html">SpStreamOperator</a>(),
00034     m_fOffsetX(fX),
00035     m_fOffsetY(fY),
00036     m_fOffsetZ(fZ),
00037     m_fX(fX), m_fY(fY), m_fZ(fZ),
00038     m_fOctaves(fOctaves),
00039     m_fIncrement(fIncrement),
00040     m_fLacunarity(fLacunarity),
00041     m_uiCurrentPass(0),
00042     m_adExponents(0),
00043     m_bInitialized(false),
00044     m_bCreateTextures(true),
00045     m_pkIdentityVertexProgram(0),
00046     m_pkAddMultiTextureProgram(0)
00047 {
00048     GLint iMaxTextureUnits = 0;
00049 
00050     <span class="comment">// GL_MAX_TEXTURE_UNITS is the "old" constant for</span>
00051     <span class="comment">// fixed function multi-texturing, and has a max value of 4.</span>
00052     <span class="comment">// Since NV30+ cards have 16+ texture units, this is a waste</span>
00053     <span class="comment">// of unused resources.</span>
00054     <span class="comment">//</span>
00055     <span class="comment">// GL_MAX_TEXTURE_IMAGE_UNITS_ARB is suppose to report the</span>
00056     <span class="comment">// number of available texture units for programmable</span>
00057     <span class="comment">// shader programs, so lets use that instead.</span>
00058 
00059     glGetIntegerv(GL_MAX_TEXTURE_IMAGE_UNITS_ARB, &amp;iMaxTextureUnits);
00060     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p10">m_uiMaxOctaves</a> = iMaxTextureUnits;
00061 
00062     <span class="comment">// clamp the octave count to the texture unit count, and user value</span>
00063     <span class="keywordflow">if</span>(fOctaves &gt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p10">m_uiMaxOctaves</a>)
00064     {
00065         fOctaves = (<span class="keywordtype">float</span>)<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p10">m_uiMaxOctaves</a>;
00066     }
00067     <span class="keywordflow">else</span>
00068     {
00069         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p10">m_uiMaxOctaves</a> = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)fOctaves;
00070     }
00071 
00072     <span class="comment">// create the exponent array of spectral weights, fill with 0 for now</span>
00073     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p14">m_adExponents</a> = <span class="keyword">new</span> <span class="keywordtype">double</span>[<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p10">m_uiMaxOctaves</a>];
00074     memset(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p14">m_adExponents</a>, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p10">m_uiMaxOctaves</a>);
00075 
00076     <span class="comment">// set the number of texture units based on octave count</span>
00077     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a> = (<span class="keywordtype">int</span>)fOctaves;
00078     <span class="keywordtype">float</span> fRemainder = fOctaves - (<span class="keywordtype">int</span>)fOctaves;
00079 
00080     <span class="keywordflow">if</span> ( fRemainder )
00081         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a>++;
00082 
00083     <span class="keywordflow">if</span> ( <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a> &gt; m_uiMaxOctaves )
00084         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a> = m_uiMaxOctaves;
00085 
00086     <span class="comment">// create the texture index array, and fill with 0 for now</span>
00087     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p16">m_auiTextures</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>[ <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a> ];
00088     memset(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p16">m_auiTextures</a>, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) * <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a>);
00089 
00090     fprintf(stderr, <span class="stringliteral">"Turblence: Octaves[%d] Textures[%d]\n"</span>,
00091             (<span class="keywordtype">int</span>)<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a>, m_uiTextureCount);
00092 }
00093 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00094"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a1">00094</a> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a1">SpTurbulenceOp::~SpTurbulenceOp</a>()
00095 {
00096     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iTex = 0; iTex &lt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a>; iTex++)
00097         <a class="code" href="classSpark_1_1SpGlManager.html#e0">SpGlManager::deleteTexture</a>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p16">m_auiTextures</a>[iTex]);
00098 
00099     <span class="keyword">delete</span>[] <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p14">m_adExponents</a>;
00100     <span class="keyword">delete</span>[] <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p16">m_auiTextures</a>;
00101 }
00102 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00103"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a2">00103</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a2">SpTurbulenceOp::initialize</a>(
00104     <a class="code" href="classSpark_1_1SpStreamBuffer.html">SpStreamBuffer</a>* pkBuffer, <a class="code" href="classSpark_1_1SpStreamFeedback.html">SpStreamFeedback</a> *pkCopy, <span class="keywordtype">bool</span> bCreateTextures)
00105 {
00106     <span class="keywordflow">if</span>(!pkBuffer)
00107         <span class="keywordflow">return</span>;
00108 
00109     <span class="comment">// load the vertex program</span>
00110     <span class="keywordflow">if</span>(!<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p18">m_pkIdentityVertexProgram</a>)
00111     {
00112         <span class="keywordflow">if</span>(pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a35">isRectangleTexture</a>())
00113         {
00114             <span class="comment">// non-power of two</span>
00115             <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p18">m_pkIdentityVertexProgram</a> = <a class="code" href="classSpark_1_1SpGlslManager.html#e7">SpGlslManager::loadVertexProgramFromFile</a>(
00116                 kVPTex2DFilename.c_str()
00117             );
00118         }
00119         <span class="keywordflow">else</span>
00120         {
00121             <span class="comment">// use the same vertex program for non-rectangle textures</span>
00122             <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p18">m_pkIdentityVertexProgram</a> = <a class="code" href="classSpark_1_1SpGlslManager.html#e7">SpGlslManager::loadVertexProgramFromFile</a>(
00123                 kVPTex2DFilename.c_str()
00124             );
00125         }
00126 
00127         assert(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p18">m_pkIdentityVertexProgram</a>);
00128         <a class="code" href="classSpark_1_1SpGlslManager.html#e0">SpGlslManager::compile</a>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p18">m_pkIdentityVertexProgram</a>);
00129     }
00130 
00131     <span class="comment">// load the fragment program</span>
00132     <span class="keywordflow">if</span>(!<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p19">m_pkAddMultiTextureProgram</a>)
00133     {
00134         <span class="keywordflow">if</span>(pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a35">isRectangleTexture</a>())
00135         {
00136             <span class="comment">// rectangle program</span>
00137             <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p19">m_pkAddMultiTextureProgram</a> = <a class="code" href="classSpark_1_1SpGlslManager.html#e8">SpGlslManager::loadFragmentProgramFromFile</a>(
00138                 kFPTex2DRectFilename.c_str()
00139             );
00140         }
00141         <span class="keywordflow">else</span>
00142         {
00143             <span class="comment">// power of two program</span>
00144             <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p19">m_pkAddMultiTextureProgram</a> = <a class="code" href="classSpark_1_1SpGlslManager.html#e8">SpGlslManager::loadFragmentProgramFromFile</a>(
00145                 kFPTex2DFilename.c_str()
00146             );
00147         }
00148 
00149         assert(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p19">m_pkAddMultiTextureProgram</a>);
00150         <a class="code" href="classSpark_1_1SpGlslManager.html#e0">SpGlslManager::compile</a>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p19">m_pkAddMultiTextureProgram</a>);
00151     }
00152 
00153     <span class="comment">// compute spectral weights for each frequency</span>
00154     <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p10">m_uiMaxOctaves</a>; i++ )
00155         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p14">m_adExponents</a>[i] = <a class="code" href="namespaceSpark.html#a47">Pow</a>( (<span class="keywordtype">double</span>)<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p1">m_fLacunarity</a>, (<span class="keywordtype">double</span>)i * -<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p2">m_fIncrement</a> );
00156 
00157 
00158     <span class="comment">// create textures for each octave and store texture ids</span>
00159     <span class="keywordflow">if</span>(bCreateTextures)
00160     {
00161         <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p16">m_auiTextures</a>[0])
00162         {
00163             <span class="comment">// delete any existing textures</span>
00164             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iTex = 0; iTex &lt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a>; iTex++)
00165                 <a class="code" href="classSpark_1_1SpGlManager.html#e0">SpGlManager::deleteTexture</a>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p16">m_auiTextures</a>[iTex]);
00166         }
00167         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iTex = 0; iTex &lt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a>; iTex++)
00168         {
00169             <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p16">m_auiTextures</a>[iTex] = <a class="code" href="classSpark_1_1SpGlManager.html#e2">SpGlManager::createFilteredTexture</a>(
00170                 pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a19">getWidth</a>(),
00171                 pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a20">getHeight</a>(),
00172                 pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a17">getTextureTarget</a>()
00173             );
00174         }
00175         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p12">m_bCreateTextures</a> = <span class="keyword">false</span>;
00176     }
00177 
00178     <span class="comment">// toggle initialized state</span>
00179     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p13">m_bInitialized</a> = <span class="keyword">true</span>;
00180     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a> = 0;
00181 }
00182 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00183"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#b0">00183</a> <span class="keywordtype">bool</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#b0">SpTurbulenceOp::enableOutputStream</a>(<a class="code" href="classSpark_1_1SpStreamBuffer.html">SpStreamBuffer</a>* pkBuffer, <a class="code" href="classSpark_1_1SpStreamFeedback.html">SpStreamFeedback</a> *pkCopy)
00184 {
00185     <span class="keywordflow">if</span>(!pkBuffer || !pkCopy)
00186         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00187 
00188     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a> &lt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a>)
00189     {
00190         pkCopy-&gt;<a class="code" href="classSpark_1_1SpStreamFeedback.html#a0">setOutputTexture</a>(
00191             <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p16">m_auiTextures</a>[<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a>],
00192             pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a17">getTextureTarget</a>(),
00193             pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a19">getWidth</a>(), pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a20">getHeight</a>()
00194         );
00195     }
00196     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00197 }
00198 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00199"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#b1">00199</a> <span class="keywordtype">bool</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#b1">SpTurbulenceOp::setupState</a>(<a class="code" href="classSpark_1_1SpStreamBuffer.html">SpStreamBuffer</a>* pkBuffer, <a class="code" href="classSpark_1_1SpStreamFeedback.html">SpStreamFeedback</a> *pkCopy)
00200 {
00201     <span class="keywordflow">if</span>(!pkBuffer || !pkCopy)
00202         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00203 
00204     <span class="keywordflow">if</span>(!<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p13">m_bInitialized</a>)
00205         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a2">initialize</a>(pkBuffer, pkCopy, <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p12">m_bCreateTextures</a>);
00206 
00207     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a> == 0)
00208     {
00209         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p6">m_fX</a> = <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p3">m_fOffsetX</a>;
00210         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p7">m_fY</a> = <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p4">m_fOffsetY</a>;
00211         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p8">m_fZ</a> = <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p5">m_fOffsetZ</a>;
00212     }
00213 
00214     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a> &lt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a> &amp;&amp; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p11">m_bInputIsBasis</a>)
00215     {
00216         <a class="code" href="classSpark_1_1SpStreamBasis.html">SpStreamBasis</a>* pkBasis = static_cast&lt;SpStreamBasis*&gt;(m_pkInputStream);
00217         pkBasis-&gt;<a class="code" href="classSpark_1_1SpStreamBasis.html#a4">setWeight</a>( (<span class="keywordtype">float</span>)<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p14">m_adExponents</a>[<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a>] );
00218         pkBasis-&gt;<a class="code" href="classSpark_1_1SpStreamBasis.html#a6">setOffset</a>( <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p6">m_fX</a>, <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p7">m_fY</a>, <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p8">m_fZ</a> );
00219     }
00220     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00221 }
00222 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00223"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#b2">00223</a> <span class="keywordtype">bool</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#b2">SpTurbulenceOp::processStream</a>(<a class="code" href="classSpark_1_1SpStreamBuffer.html">SpStreamBuffer</a>* pkBuffer, <a class="code" href="classSpark_1_1SpStreamFeedback.html">SpStreamFeedback</a> *pkCopy)
00224 {
00225     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a> &lt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a>)
00226     {
00227         <span class="keywordflow">return</span> m_pkInputStream-&gt;<a class="code" href="classSpark_1_1SpStreamInput.html#a3">sendOutputToBuffer</a>( pkBuffer, pkCopy );
00228     }
00229     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00230 }
00231 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00232"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#b3">00232</a> <span class="keywordtype">bool</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#b3">SpTurbulenceOp::updateOutputStream</a>(
00233     <a class="code" href="classSpark_1_1SpStreamBuffer.html">SpStreamBuffer</a>* pkBuffer, <a class="code" href="classSpark_1_1SpStreamFeedback.html">SpStreamFeedback</a> *pkCopy)
00234 {
00235     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a> &gt;= <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a>)
00236     {
00237         <span class="keywordflow">if</span> (pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a30">isInitialized</a>() &amp;&amp; pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a6">enable</a>())
00238         {
00239             <span class="keywordflow">if</span> (pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a34">isDoubleBuffered</a>()) glDrawBuffer(GL_BACK);
00240 
00241             pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a6">enable</a>();
00242 
00243             glMatrixMode(GL_MODELVIEW);
00244             glPushMatrix();
00245             glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
00246             {
00247                 <a class="code" href="classSpark_1_1SpGlslManager.html#e2">SpGlslManager::enable</a>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p18">m_pkIdentityVertexProgram</a>);
00248                 <a class="code" href="classSpark_1_1SpGlslManager.html#e2">SpGlslManager::enable</a>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p19">m_pkAddMultiTextureProgram</a>);
00249 
00250                 <span class="comment">// bind all of the textures to the appropriate parameter values</span>
00251                 <span class="comment">// and make then active for the programmable shaders</span>
00252                 <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p17">m_uiTextureCount</a>; i++)
00253                 {
00254                     <a class="code" href="classSpark_1_1SpString.html">SpString</a> kCurrentParam = kTextureParam;
00255                     kCurrentParam.<a class="code" href="classSpark_1_1SpString.html#a20">add</a>(i);
00256                     glActiveTexture(GL_TEXTURE0 + i);
00257                     glBindTexture( pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a17">getTextureTarget</a>(), <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p16">m_auiTextures</a>[i] );
00258                     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p19">m_pkAddMultiTextureProgram</a>-&gt;<a class="code" href="classSpark_1_1SpGlslFragmentProgram.html#a1">setParameter1i</a>(kCurrentParam, i);
00259                 }
00260 
00261                 <span class="keywordtype">float</span> fMaxS = (<span class="keywordtype">float</span>)pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a21">getMaxS</a>();
00262                 <span class="keywordtype">float</span> fMaxT = (<span class="keywordtype">float</span>)pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a22">getMaxT</a>();
00263 
00264                 glBegin(GL_QUADS);
00265                 glTexCoord2f(0, 0);         glVertex2f(-1, -1);
00266                 glTexCoord2f(fMaxS, 0);     glVertex2f( 1, -1);
00267                 glTexCoord2f(fMaxS, fMaxT); glVertex2f( 1,  1);
00268                 glTexCoord2f(0, fMaxT);     glVertex2f(-1,  1);
00269                 glEnd();
00270 
00271                 <a class="code" href="classSpark_1_1SpGlslManager.html#e3">SpGlslManager::disable</a>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p18">m_pkIdentityVertexProgram</a>);
00272                 <a class="code" href="classSpark_1_1SpGlslManager.html#e3">SpGlslManager::disable</a>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p19">m_pkAddMultiTextureProgram</a>);
00273             }
00274             glPopMatrix();
00275             pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a8">disable</a>();
00276             m_bHasChanged = <span class="keyword">false</span>;
00277             glFlush();
00278             <span class="comment">//glutSwapBuffers();</span>
00279             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00280         }
00281     }
00282     <span class="comment">//m_bHasChanged = true;</span>
00283     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00284 }
00285 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00286"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#b4">00286</a> <span class="keywordtype">bool</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#b4">SpTurbulenceOp::resetState</a>(<a class="code" href="classSpark_1_1SpStreamBuffer.html">SpStreamBuffer</a>* pkBuffer, <a class="code" href="classSpark_1_1SpStreamFeedback.html">SpStreamFeedback</a> *pkCopy)
00287 {
00288     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a> &lt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a>)
00289     {
00290         <span class="comment">// multipy in the lacunarity to create the gaps between octaves</span>
00291         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p6">m_fX</a> *= <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p1">m_fLacunarity</a>;
00292         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p7">m_fY</a> *= m_fLacunarity;
00293         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p8">m_fZ</a> *= m_fLacunarity;
00294 
00295         <span class="comment">// increment the current pass number</span>
00296         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a>++;
00297         m_bHasChanged = <span class="keyword">true</span>;
00298     }
00299     <span class="keywordflow">else</span>
00300     {
00301         <span class="comment">// reset the current pass to zero</span>
00302         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a> = 0;
00303 
00304         <span class="comment">// reset the evaluation point to original offset</span>
00305         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p6">m_fX</a> = <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p3">m_fOffsetX</a>;
00306         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p7">m_fY</a> = <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p4">m_fOffsetY</a>;
00307         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p8">m_fZ</a> = <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p5">m_fOffsetZ</a>;
00308     }
00309     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00310 }
00311 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00312"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#b5">00312</a> <span class="keywordtype">bool</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#b5">SpTurbulenceOp::disableOutputStream</a>(
00313     <a class="code" href="classSpark_1_1SpStreamBuffer.html">SpStreamBuffer</a>* pkBuffer, <a class="code" href="classSpark_1_1SpStreamFeedback.html">SpStreamFeedback</a> *pkCopy)
00314 {
00315     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00316 }
00317 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00318"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a7">00318</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a7">SpTurbulenceOp::setLacunarity</a>(<span class="keywordtype">float</span> fLacunarity)
00319 {
00320     <span class="keywordflow">if</span>(fLacunarity == <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p1">m_fLacunarity</a>)
00321         <span class="keywordflow">return</span>;
00322 
00323     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p1">m_fLacunarity</a> = fLacunarity;
00324     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p13">m_bInitialized</a> = <span class="keyword">false</span>;
00325     m_bHasChanged = <span class="keyword">true</span>;
00326 }
00327 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00328"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a8">00328</a> <span class="keywordtype">float</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a8">SpTurbulenceOp::getLacunarity</a>()<span class="keyword"> const</span>
00329 <span class="keyword"></span>{
00330     <span class="keywordflow">return</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p1">m_fLacunarity</a>;
00331 
00332 }
00333 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00334"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a9">00334</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a9">SpTurbulenceOp::setIncrement</a>(<span class="keywordtype">float</span> fIncrement)
00335 {
00336     <span class="keywordflow">if</span>(fIncrement == <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p2">m_fIncrement</a>)
00337         <span class="keywordflow">return</span>;
00338 
00339     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p2">m_fIncrement</a> = fIncrement;
00340     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p13">m_bInitialized</a> = <span class="keyword">false</span>;
00341     m_bHasChanged = <span class="keyword">true</span>;
00342 }
00343 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00344"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a10">00344</a> <span class="keywordtype">float</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a10">SpTurbulenceOp::getIncrement</a>()<span class="keyword"> const</span>
00345 <span class="keyword"></span>{
00346     <span class="keywordflow">return</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p2">m_fIncrement</a>;
00347 }
00348 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00349"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a11">00349</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a11">SpTurbulenceOp::setOffset</a>(<span class="keywordtype">float</span> fX, <span class="keywordtype">float</span> fY, <span class="keywordtype">float</span> fZ)
00350 {
00351     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p3">m_fOffsetX</a> = fX;
00352     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p4">m_fOffsetY</a> = fY;
00353     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p5">m_fOffsetZ</a> = fZ;
00354     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p9">m_uiCurrentPass</a> = 0;
00355     m_bHasChanged = <span class="keyword">true</span>;
00356 }
00357 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00358"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a12">00358</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a12">SpTurbulenceOp::getOffset</a>(<span class="keywordtype">float</span>&amp; rfX, <span class="keywordtype">float</span>&amp; rfY, <span class="keywordtype">float</span>&amp; rfZ)<span class="keyword"> const</span>
00359 <span class="keyword"></span>{
00360     rfX = <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p3">m_fOffsetX</a>;
00361     rfY = <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p4">m_fOffsetY</a>;
00362     rfZ = <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p5">m_fOffsetZ</a>;
00363 }
00364 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00365"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a5">00365</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a5">SpTurbulenceOp::setOctaves</a>(<span class="keywordtype">float</span> fOctaves)
00366 {
00367     <span class="keywordflow">if</span>(fOctaves == <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a>)
00368         <span class="keywordflow">return</span>;
00369 
00370     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a> = fOctaves;
00371     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a> &gt; <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p10">m_uiMaxOctaves</a>)
00372     {
00373         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p13">m_bInitialized</a> = <span class="keyword">false</span>;
00374         <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p12">m_bCreateTextures</a> = <span class="keyword">true</span>;
00375     }
00376     m_bHasChanged = <span class="keyword">true</span>;
00377 }
00378 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00379"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a6">00379</a> <span class="keywordtype">float</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a6">SpTurbulenceOp::getOctaves</a>()<span class="keyword"> const</span>
00380 <span class="keyword"></span>{
00381     <span class="keywordflow">return</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p0">m_fOctaves</a>;
00382 }
00383 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00384"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a3">00384</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a3">SpTurbulenceOp::setInputStream</a>(<a class="code" href="classSpark_1_1SpStreamBasis.html">SpStreamBasis</a>* pkInputStream)
00385 {
00386     <a class="code" href="classSpark_1_1SpStreamOperator.html#a2">SpStreamOperator::setInputStream</a>(pkInputStream);
00387     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p11">m_bInputIsBasis</a> = <span class="keyword">true</span>;
00388 }
00389 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00390"></a><a class="code" href="classSpark_1_1SpTurbulenceOp.html#a4">00390</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpTurbulenceOp.html#a3">SpTurbulenceOp::setInputStream</a>(<a class="code" href="classSpark_1_1SpStreamInput.html">SpStreamInput</a>* pkInputStream)
00391 {
00392     <a class="code" href="classSpark_1_1SpStreamOperator.html#a2">SpStreamOperator::setInputStream</a>(pkInputStream);
00393     <a class="code" href="classSpark_1_1SpTurbulenceOp.html#p11">m_bInputIsBasis</a> = <span class="keyword">false</span>;
00394 }
00395 <span class="comment">//----------------------------------------------------------------------------</span>
</div></pre>		<div class="footer" width="100%">
		<hr>
			<a href="http://lyon-smith.org/">&copy; Derek Gerstmann - NCCA - Bournemouth University - 2004</a>
		</div>
		<br>
	</body>
</html>
