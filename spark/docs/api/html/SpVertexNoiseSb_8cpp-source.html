<html>
	<head>
		<title>SPARK: Stream Processing Abstraction and Rendering Toolkit</title>
		<link HREF="style.css" REL="stylesheet" TYPE="text/css">
	</head>
	<body>
		<div width="100%" height="40px" class="banner">
			Spark API Documentation
		</div>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>SpVertexNoiseSb.cpp</h1><a href="SpVertexNoiseSb_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="preprocessor">#include "<a class="code" href="SpVertexNoiseSb_8h.html">SpVertexNoiseSb.h</a>"</span>
00003 <span class="preprocessor">#include "SpSpGlslVertexProgram.h"</span>
00004 <span class="preprocessor">#include "<a class="code" href="SpGlslFragmentProgram_8h.html">SpGlslFragmentProgram.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="SpGlslManager_8h.html">SpGlslManager.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="SpGlutHeaders_8h.html">SpGlutHeaders.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="SpTuple_8h.html">SpTuple.h</a>"</span>
00008 <span class="preprocessor">#include "SPRandom.h"</span>
00009 
00010 <span class="comment">//----------------------------------------------------------------------------</span>
00011 
00012 <span class="keyword">using</span> <span class="keyword">namespace </span>Spark;
00013 
00014 <span class="comment">//----------------------------------------------------------------------------</span>
00015 
00016 <span class="comment">// must be same as B in VertexNoise.glsl</span>
00017 <span class="keyword">static</span> <span class="keywordtype">int</span> gs_iTableSize = 64;
00018 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classSpark_1_1SpString.html">SpString</a> gs_kFPColoredFragmentFilename = <span class="stringliteral">"ColoredFragment.fp"</span>;
00019 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classSpark_1_1SpString.html">SpString</a> gs_kVPOneOctaveNoiseFilename = <span class="stringliteral">"OneOctaveNoise.vp"</span>;
00020 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classSpark_1_1SpString.html">SpString</a> gs_kVPOneOctaveAbsNoiseFilename = <span class="stringliteral">"OneOctaveAbsNoise.vp"</span>;
00021 
00022 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00023"></a><a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a0">00023</a> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a0">SpVertexNoiseSb::SpVertexNoiseSb</a>(
00024     <span class="keywordtype">bool</span> bAbsNoise,
00025     <span class="keywordtype">float</span> fOffsetX, <span class="keywordtype">float</span> fOffsetY, <span class="keywordtype">float</span> fOffsetZ,
00026     <span class="keywordtype">float</span> fScaleX, <span class="keywordtype">float</span> fScaleY, <span class="keywordtype">float</span> fScaleZ,
00027     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiGridResolution,
00028     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ulSeed)
00029 :
00030     <a class="code" href="classSpark_1_1SpStreamBasis.html">SpStreamBasis</a>(),
00031     m_fOffsetX(fOffsetX),
00032     m_fOffsetY(fOffsetY),
00033     m_fOffsetZ(fOffsetZ),
00034     m_fScaleX(fScaleX),
00035     m_fScaleY(fScaleY),
00036     m_fScaleZ(fScaleZ),
00037     m_fWeight(1.0f),
00038     m_aiP(0), m_akPG(0),
00039     m_pkVertexProgram(0),
00040     m_pkFragmentProgram(0),
00041     m_ulSeed(ulSeed)
00042 {
00043     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p7">m_kGrid</a>.<a class="code" href="classSpark_1_1SpTexturedGridSg.html#a3">setResolution</a>(uiGridResolution, uiGridResolution);
00044 
00045     <span class="keywordflow">if</span>(bAbsNoise)
00046         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a> = <a class="code" href="classSpark_1_1SpGlslManager.html#e7">SpGlslManager::loadVertexProgramFromFile</a>(
00047             gs_kVPOneOctaveAbsNoiseFilename.c_str()
00048         );
00049     <span class="keywordflow">else</span>
00050         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a> = <a class="code" href="classSpark_1_1SpGlslManager.html#e7">SpGlslManager::loadVertexProgramFromFile</a>(
00051             gs_kVPOneOctaveNoiseFilename.c_str()
00052         );
00053 
00054     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p1">m_pkFragmentProgram</a> = <a class="code" href="classSpark_1_1SpGlslManager.html#e8">SpGlslManager::loadFragmentProgramFromFile</a>(
00055         gs_kFPColoredFragmentFilename.c_str()
00056     );
00057 
00058     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p5">m_bHasChanged</a> = <span class="keyword">true</span>;
00059 
00060     assert(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>);
00061     assert(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p1">m_pkFragmentProgram</a>);
00062 }
00063 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00064"></a><a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a1">00064</a> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a1">SpVertexNoiseSb::~SpVertexNoiseSb</a>()
00065 {
00066     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a3">destroy</a>();
00067 }
00068 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00069"></a><a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a2">00069</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a2">SpVertexNoiseSb::initialize</a>()
00070 {
00071     <span class="comment">// delete the tables if they already exist</span>
00072     <span class="keywordflow">if</span>( <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p2">m_aiP</a> ) <span class="keyword">delete</span>[] <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p2">m_aiP</a>;
00073     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p2">m_aiP</a> = NULL;
00074 
00075     <span class="keywordflow">if</span>( <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a> ) <span class="keyword">delete</span>[] <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>;
00076     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a> = NULL;
00077 
00078     <span class="comment">// seed the randon number generator</span>
00079     <a class="code" href="namespaceSpark.html#a112">SeedRandom</a>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p6">m_ulSeed</a>);
00080 
00081     <span class="comment">// allocate storage for the permutation table</span>
00082     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p2">m_aiP</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[gs_iTableSize*2+2];
00083 
00084     <span class="comment">// allocate storage for the gradient table</span>
00085     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a> = <span class="keyword">new</span> <a class="code" href="classSpark_1_1SpTuple4.html">SpVector4f</a>[gs_iTableSize*2+2];
00086 
00087     <span class="comment">// initalize random gradients</span>
00088     <span class="keywordtype">int</span> i;
00089     <span class="keywordflow">for</span>(i=0; i&lt;gs_iTableSize; i++)
00090     {
00091         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p2">m_aiP</a>[i] = i;
00092         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[i][0] = <a class="code" href="namespaceSpark.html#a116">RandomSymmetricFloat</a>();
00093         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[i][1] = <a class="code" href="namespaceSpark.html#a116">RandomSymmetricFloat</a>();
00094         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[i][2] = <a class="code" href="namespaceSpark.html#a116">RandomSymmetricFloat</a>();
00095         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[i] = <a class="code" href="namespaceSpark.html#a122">Normalize</a>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[i]);
00096     }
00097 
00098     <span class="comment">// initialize permutation table (random shuffle)</span>
00099     <span class="keywordflow">for</span>(i=0; i&lt;gs_iTableSize; i++)
00100     {
00101         <span class="keywordtype">int</span> j, t;
00102         j = (<a class="code" href="namespaceSpark.html#a113">RandomUInt</a>() &gt;&gt; 4) % gs_iTableSize;
00103         t = <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p2">m_aiP</a>[i];
00104         m_aiP[i] = m_aiP[j];
00105         m_aiP[j] = t;
00106 
00107         <span class="comment">// set the permutation index to the 4th vector component (w)</span>
00108         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[i][3] = (<span class="keywordtype">float</span>) m_aiP[i];
00109 
00110         <span class="comment">// mirror first half of table into second half</span>
00111         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[i+gs_iTableSize][0] = <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[i][0];
00112         m_akPG[i+gs_iTableSize][1] = m_akPG[i][1];
00113         m_akPG[i+gs_iTableSize][2] = m_akPG[i][2];
00114         m_akPG[i+gs_iTableSize][3] = m_akPG[i][3];
00115     }
00116 
00117     <span class="comment">// set the last values to the first for wrap-around</span>
00118     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[gs_iTableSize*2] = <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>[0];
00119     m_akPG[(gs_iTableSize*2)+1] = m_akPG[1];
00120 
00121     <span class="comment">// compile the program and submit the parameter data</span>
00122     <a class="code" href="classSpark_1_1SpGlslManager.html#e0">SpGlslManager::compile</a>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>);
00123     <a class="code" href="classSpark_1_1SpGlslManager.html#e1">SpGlslManager::bind</a>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>);
00124     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>-&gt;<a class="code" href="classSpark_1_1SpGlslVertexProgram.html#a16">setParameter4fv</a>(
00125         <span class="stringliteral">"pg[0]"</span>, m_akPG[0].values(), gs_iTableSize*2+2
00126     );
00127 
00128     <span class="comment">// toggle initialized flag</span>
00129     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p4">m_bIsInitialized</a> = <span class="keyword">true</span>;
00130 }
00131 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00132"></a><a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a3">00132</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a3">SpVertexNoiseSb::destroy</a>()
00133 {
00134     <span class="comment">// delete the tables if they already exist</span>
00135     <span class="keywordflow">if</span>( <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p2">m_aiP</a> ) <span class="keyword">delete</span>[] <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p2">m_aiP</a>;
00136     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p2">m_aiP</a> = NULL;
00137 
00138     <span class="keywordflow">if</span>( <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a> ) <span class="keyword">delete</span>[] <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a>;
00139     <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p3">m_akPG</a> = NULL;
00140 
00141     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>)
00142     {
00143         <a class="code" href="classSpark_1_1SpGlslManager.html#e4">SpGlslManager::release</a>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>);
00144         <span class="keyword">delete</span> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>;
00145     }
00146 }
00147 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00148"></a><a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a4">00148</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a4">SpVertexNoiseSb::preload</a>()
00149 {
00150     <span class="keywordflow">if</span>(!<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p4">m_bIsInitialized</a>)
00151         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a2">initialize</a>();
00152 }
00153 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00154"></a><a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a5">00154</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a5">SpVertexNoiseSb::enable</a>()
00155 {
00156     <span class="keywordflow">if</span>(!<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p4">m_bIsInitialized</a>)
00157         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a2">initialize</a>();
00158 
00159     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>)
00160     {
00161         <a class="code" href="classSpark_1_1SpGlslManager.html#e2">SpGlslManager::enable</a>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>);
00162         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>-&gt;<a class="code" href="classSpark_1_1SpGlslVertexProgram.html#a9">setParameter1f</a>( <span class="stringliteral">"Exponent"</span>, <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p14">m_fWeight</a> );
00163         <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>-&gt;<a class="code" href="classSpark_1_1SpGlslVertexProgram.html#a9">setParameter1f</a>( <span class="stringliteral">"Offset"</span>, 0.0f );
00164     }
00165 
00166     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p1">m_pkFragmentProgram</a>)
00167     {
00168         <a class="code" href="classSpark_1_1SpGlslManager.html#e2">SpGlslManager::enable</a>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p1">m_pkFragmentProgram</a>);
00169     }
00170 }
00171 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00172"></a><a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a6">00172</a> <span class="keywordtype">void</span> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a6">SpVertexNoiseSb::disable</a>()
00173 {
00174     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>)
00175         <a class="code" href="classSpark_1_1SpGlslManager.html#e3">SpGlslManager::disable</a>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p0">m_pkVertexProgram</a>);
00176 
00177     <span class="keywordflow">if</span>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p1">m_pkFragmentProgram</a>)
00178         <a class="code" href="classSpark_1_1SpGlslManager.html#e3">SpGlslManager::disable</a>(<a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p1">m_pkFragmentProgram</a>);
00179 
00180 }
00181 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00182"></a><a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a15">00182</a> <span class="keywordtype">bool</span> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a15">SpVertexNoiseSb::hasChanged</a>()
00183 {
00184     <span class="keywordflow">return</span> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p5">m_bHasChanged</a>;
00185 }
00186 <span class="comment">//----------------------------------------------------------------------------</span>
<a name="l00187"></a><a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a16">00187</a> <span class="keywordtype">bool</span> <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a16">SpVertexNoiseSb::sendOutputToBuffer</a>(
00188     <a class="code" href="classSpark_1_1SpStreamBuffer.html">SpStreamBuffer</a>* pkBuffer, <a class="code" href="classSpark_1_1SpCopyToTextureFb.html">SpCopyToTextureFb</a> *pkCopy)
00189 {
00190     <span class="comment">//if(m_bHasChanged)</span>
00191     {
00192         <span class="keywordflow">if</span> (pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a30">isInitialized</a>() &amp;&amp; pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a6">enable</a>())
00193         {
00194             <span class="keywordflow">if</span> (pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a34">isDoubleBuffered</a>()) glDrawBuffer(GL_BACK);
00195 
00196             <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a5">enable</a>();
00197 
00198             glMatrixMode(GL_TEXTURE);
00199             glLoadIdentity();
00200             glTranslatef( <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p8">m_fOffsetX</a>, <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p9">m_fOffsetY</a>, <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p10">m_fOffsetZ</a> );
00201             glScalef( <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p11">m_fScaleX</a>, <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p12">m_fScaleY</a>, <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p13">m_fScaleZ</a> );
00202 
00203             glMatrixMode(GL_MODELVIEW);
00204             glPushMatrix();
00205             glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
00206 
00207             <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p7">m_kGrid</a>.<a class="code" href="classSpark_1_1SpTexturedGridSg.html#a2">render</a>();
00208 
00209             glPopMatrix();
00210 
00211             <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#a6">disable</a>();
00212 
00213             glMatrixMode(GL_TEXTURE);
00214             glLoadIdentity();
00215             glMatrixMode(GL_MODELVIEW);
00216 
00217             <span class="keywordflow">if</span>(pkCopy)
00218                 pkCopy-&gt;<a class="code" href="classSpark_1_1SpCopyToTextureFb.html#a3">updateOutput</a>();
00219 
00220             pkBuffer-&gt;<a class="code" href="classSpark_1_1SpStreamBuffer.html#a8">disable</a>();
00221             glFlush();
00222             <a class="code" href="classSpark_1_1SpVertexNoiseSb.html#p5">m_bHasChanged</a> = <span class="keyword">false</span>;
00223             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00224         }
00225     }
00226     <span class="comment">//m_bHasChanged = false;</span>
00227     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00228 }
00229 <span class="comment">//----------------------------------------------------------------------------</span>
</div></pre>		<div class="footer" width="100%">
		<hr>
			<a href="http://lyon-smith.org/">&copy; Derek Gerstmann - NCCA - Bournemouth University - 2004</a>
		</div>
		<br>
	</body>
</html>
